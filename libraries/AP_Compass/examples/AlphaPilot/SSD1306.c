#include <string.h>
#include "SSD1306.h"

// extern "C" {
#include "DSP.h"
#include "StaP.h"
#include "BaseI2C.h"
// }

//
// OLED display interface
//

#define SSD1306_128_64 1

#if defined SSD1306_128_64
  #define SSD1306_LCDWIDTH                  128
  #define SSD1306_LCDHEIGHT                 64
#endif
#if defined SSD1306_128_32
  #define SSD1306_LCDWIDTH                  128
  #define SSD1306_LCDHEIGHT                 32
#endif
#if defined SSD1306_96_16
  #define SSD1306_LCDWIDTH                  96
  #define SSD1306_LCDHEIGHT                 16
#endif

#define SSD1306_SETCONTRAST 0x81
#define SSD1306_DISPLAYALLON_RESUME 0xA4
#define SSD1306_DISPLAYALLON 0xA5
#define SSD1306_NORMALDISPLAY 0xA6
#define SSD1306_INVERTDISPLAY 0xA7
#define SSD1306_DISPLAYOFF 0xAE
#define SSD1306_DISPLAYON 0xAF

#define SSD1306_SETDISPLAYOFFSET 0xD3
#define SSD1306_SETCOMPINS 0xDA

#define SSD1306_SETVCOMDETECT 0xDB

#define SSD1306_SETDISPLAYCLOCKDIV 0xD5
#define SSD1306_SETPRECHARGE 0xD9

#define SSD1306_SETMULTIPLEX 0xA8

#define SSD1306_SETLOWCOLUMN 0x00
#define SSD1306_SETHIGHCOLUMN 0x10

#define SSD1306_SETSTARTLINE 0x40

#define SSD1306_MEMORYMODE 0x20
#define SSD1306_COLUMNADDR 0x21
#define SSD1306_PAGEADDR   0x22

#define SSD1306_COMSCANINC 0xC0
#define SSD1306_COMSCANDEC 0xC8

#define SSD1306_SEGREMAP 0xA0

#define SSD1306_CHARGEPUMP 0x8D

#define SSD1306_EXTERNALVCC 0x1
#define SSD1306_SWITCHCAPVCC 0x2

// Scrolling #defines
#define SSD1306_ACTIVATE_SCROLL 0x2F
#define SSD1306_DEACTIVATE_SCROLL 0x2E
#define SSD1306_SET_VERTICAL_SCROLL_AREA 0xA3
#define SSD1306_RIGHT_HORIZONTAL_SCROLL 0x26
#define SSD1306_LEFT_HORIZONTAL_SCROLL 0x27
#define SSD1306_VERTICAL_AND_RIGHT_HORIZONTAL_SCROLL 0x29
#define SSD1306_VERTICAL_AND_LEFT_HORIZONTAL_SCROLL 0x2A

#define SSD1306_ADDR (0x78>>1)
#define SSD1306_TOKEN_DATA     (1<<6)
#define SSD1306_TOKEN_COMMAND  0

static uint8_t displayBuffer[DISP_ROWS*DISP_COLS];
static uint8_t cursorCol, cursorRow;
static int8_t modifiedLeft[DISP_ROWS], modifiedRight[DISP_ROWS];
static bool inverseVideo = false;
static BaseI2CTarget_t target = { "display" };
static uint8_t scanRow, scanCol;
static bool scanning = false, initialized = false;

static bool SSD1306_transmitBuffers(const I2CBuffer_t *buffers, int numBuffers) 
{
  if(!basei2cIsOnline(&target))
    return false;
  
  return basei2cInvoke(&target, basei2cWriteBuffers(SSD1306_ADDR, buffers, numBuffers));
}

static bool SSD1306_transmit(uint8_t token, const uint8_t *data, uint8_t bytes) 
{
  I2CBuffer_t buffers[] = { { &token, 1 }, { data, bytes } };
    
  return SSD1306_transmitBuffers(buffers, sizeof(buffers)/sizeof(I2CBuffer_t));
}

static bool SSD1306_data(const uint8_t *storage, uint8_t bytes) 
{
  return SSD1306_transmit(SSD1306_TOKEN_DATA, storage, bytes);
}

static bool SSD1306_command(const uint8_t value)
{
  return SSD1306_transmit(SSD1306_TOKEN_COMMAND, &value, 1);
}

void obdMove(uint8_t col, uint8_t row)
{
  cursorCol = col;
  cursorRow = row;
}

static void markModified(uint8_t col)
{
  if(col > DISP_COLS-1)
    col = DISP_COLS-1;
  
  if(modifiedLeft[cursorRow] < 0)
    modifiedLeft[cursorRow] = modifiedRight[cursorRow] = col;
  else {
    modifiedLeft[cursorRow] = MIN(modifiedLeft[cursorRow], col);
    modifiedRight[cursorRow] = MAX(modifiedRight[cursorRow], col);
  }

  if(scanning && scanRow == cursorRow && scanCol > cursorCol) {
    // We hit a line on the left of the scan, abort
    scanning = false;
    scanRow++;
  }  
}

static void nprint(const char *s, uint8_t l)
{
  int i = 0;
  
  for(i = 0; i < l; i++) {
    uint8_t c = s ? s[i] : '\0';

    if(c == '\n') {
      nprint(NULL, DISP_COLS-cursorCol);
      continue;
    }

    if(inverseVideo)
      c |= 0x80;
    
    if(displayBuffer[cursorRow*DISP_COLS + cursorCol] != c) {
      displayBuffer[cursorRow*DISP_COLS + cursorCol] = c;
      markModified(cursorCol);
    }

    if(cursorCol < DISP_COLS-1)
      cursorCol++;
    else {
      cursorCol = 0;

      if(++cursorRow > DISP_ROWS-1)
	cursorRow = DISP_ROWS-1;
    }
  }
}

void obdPrint(const char *s)
{
  inverseVideo = false;
  nprint(s, strlen(s));
}

void obdPrintAttr(const char *s, bool inv)
{
  inverseVideo = inv;
  nprint(s, strlen(s));
}

void obdClear()
{
  int i = 0;
  
  for(i = 0; i < DISP_ROWS; i++) {
    obdMove(0, i);
    obdPrint("\n");
  }
}

const uint8_t fontData[] CS_QUALIFIER = {
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0x0, 0x0, 0xC6, 0x66, 0x30, 0x18, 0xC, 0xC6,  // Char '%'
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0x0, 0x0, 0x80, 0x60, 0x60, 0x0, 0x0, 0x0,  // Char ','
0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0,  // Char '-'
0x0, 0x0, 0x0, 0xC0, 0xC0, 0x0, 0x0, 0x0,  // Char '.'
0x0, 0x40, 0x60, 0x30, 0x18, 0xC, 0x6, 0x2,  // Char '/'
0x0, 0x7C, 0xFE, 0x92, 0x8A, 0xFE, 0x7C, 0x0,  // Char '0'
0x0, 0x80, 0x88, 0xFE, 0xFE, 0x80, 0x80, 0x0,  // Char '1'
0x0, 0xC4, 0xE6, 0xA2, 0x92, 0x9E, 0x8C, 0x0,  // Char '2'
0x0, 0x44, 0xC6, 0x92, 0x92, 0xFE, 0x6C, 0x0,  // Char '3'
0x0, 0x30, 0x30, 0x28, 0x2C, 0xFE, 0xFE, 0x0,  // Char '4'
0x0, 0x4E, 0xCE, 0x8A, 0x8A, 0xFA, 0x72, 0x0,  // Char '5'
0x0, 0x7C, 0xFE, 0x92, 0x92, 0xF6, 0x64, 0x0,  // Char '6'
0x0, 0x6, 0x6, 0xF2, 0xFA, 0xE, 0x6, 0x0,  // Char '7'
0x0, 0x0, 0x6C, 0xFE, 0x92, 0x92, 0xFE, 0x6C,  // Char '8'
0x0, 0x4C, 0xDE, 0x92, 0x92, 0xFE, 0x7C, 0x0,  // Char '9'
0x0, 0x0, 0xCC, 0xCC, 0x0, 0x0, 0x0, 0x0,  // Char ':'
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0x0, 0x28, 0x28, 0x28, 0x28, 0x28, 0x0, 0x0,  // Char '='
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0x0, 0xF8, 0xFC, 0x16, 0x16, 0xFC, 0xF8, 0x0,  // Char 'A'
0x0, 0xFE, 0xFE, 0x92, 0x92, 0xFE, 0x6C, 0x0,  // Char 'B'
0x0, 0x7C, 0xFE, 0x82, 0x82, 0xC6, 0x44, 0x0,  // Char 'C'
0x0, 0xFE, 0xFE, 0x82, 0xC6, 0x7C, 0x38, 0x0,  // Char 'D'
0x0, 0xFE, 0xFE, 0x92, 0x92, 0x82, 0x82, 0x0,  // Char 'E'
0x0, 0xFE, 0xFE, 0x12, 0x12, 0x2, 0x2, 0x0,  // Char 'F'
0x0, 0x7C, 0xFE, 0x82, 0x92, 0xF6, 0x74, 0x0,  // Char 'G'
0x0, 0xFE, 0xFE, 0x10, 0x10, 0xFE, 0xFE, 0x0,  // Char 'H'
0x0, 0x0, 0x82, 0xFE, 0xFE, 0x82, 0x0, 0x0,  // Char 'I'
0x0, 0x40, 0xC0, 0x82, 0xFE, 0x7E, 0x2, 0x0,  // Char 'J'
0x0, 0xFE, 0xFE, 0x38, 0x6C, 0xC6, 0x82, 0x0,  // Char 'K'
0x0, 0xFE, 0xFE, 0x80, 0x80, 0x80, 0x80, 0x0,  // Char 'L'
0x0, 0xFE, 0xFE, 0xC, 0x18, 0xC, 0xFE, 0xFE,  // Char 'M'
0x0, 0xFE, 0xFE, 0x1C, 0x38, 0xFE, 0xFE, 0x0,  // Char 'N'
0x0, 0x7C, 0xFE, 0x82, 0x82, 0xFE, 0x7C, 0x0,  // Char 'O'
0x0, 0xFE, 0xFE, 0x12, 0x12, 0x1E, 0xC, 0x0,  // Char 'P'
0x0, 0x3C, 0x7E, 0x42, 0xC2, 0xFE, 0xBC, 0x0,  // Char 'Q'
0x0, 0xFE, 0xFE, 0x32, 0x72, 0xDE, 0x8C, 0x0,  // Char 'R'
0x0, 0x4C, 0xDE, 0x92, 0x92, 0xF6, 0x64, 0x0,  // Char 'S'
0x0, 0x2, 0x2, 0xFE, 0xFE, 0x2, 0x2, 0x0,  // Char 'T'
0x0, 0x7E, 0xFE, 0x80, 0x80, 0xFE, 0x7E, 0x0,  // Char 'U'
0x0, 0x3E, 0x7E, 0xC0, 0xC0, 0x7E, 0x3E, 0x0,  // Char 'V'
0x0, 0xFE, 0xFE, 0x60, 0x30, 0x30, 0x60, 0xFE,  // Char 'W'
0x0, 0xC6, 0xEE, 0x38, 0x38, 0xEE, 0xC6, 0x0,  // Char 'X'
0x0, 0xE, 0x1E, 0xF0, 0xF0, 0x1E, 0xE, 0x0,  // Char 'Y'
0x0, 0xC2, 0xE2, 0xB2, 0x9A, 0x8E, 0x86, 0x0,  // Char 'Z'
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0x0, 0x2, 0x6, 0xC, 0x18, 0x30, 0x60, 0x40,  // Char '\'
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x0,  // Char '_'
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0x0, 0xF8, 0xFC, 0x16, 0x16, 0xFC, 0xF8, 0x0,  // Char 'a'
0x0, 0xFE, 0xFE, 0x92, 0x92, 0xFE, 0x6C, 0x0,  // Char 'b'
0x0, 0x7C, 0xFE, 0x82, 0x82, 0xC6, 0x44, 0x0,  // Char 'c'
0x0, 0xFE, 0xFE, 0x82, 0xC6, 0x7C, 0x38, 0x0,  // Char 'd'
0x0, 0xFE, 0xFE, 0x92, 0x92, 0x82, 0x82, 0x0,  // Char 'e'
0x0, 0xFE, 0xFE, 0x12, 0x12, 0x2, 0x2, 0x0,  // Char 'f'
0x0, 0x7C, 0xFE, 0x82, 0x92, 0xF6, 0x74, 0x0,  // Char 'g'
0x0, 0xFE, 0xFE, 0x10, 0x10, 0xFE, 0xFE, 0x0,  // Char 'h'
0x0, 0x0, 0x82, 0xFE, 0xFE, 0x82, 0x0, 0x0,  // Char 'i'
0x0, 0x40, 0xC0, 0x82, 0xFE, 0x7E, 0x2, 0x0,  // Char 'j'
0x0, 0xFE, 0xFE, 0x38, 0x6C, 0xC6, 0x82, 0x0,  // Char 'k'
0x0, 0xFE, 0xFE, 0x80, 0x80, 0x80, 0x80, 0x0,  // Char 'l'
0x0, 0xFE, 0xFE, 0xC, 0x18, 0xC, 0xFE, 0xFE,  // Char 'm'
0x0, 0xFE, 0xFE, 0x1C, 0x38, 0xFE, 0xFE, 0x0,  // Char 'n'
0x0, 0x7C, 0xFE, 0x82, 0x82, 0xFE, 0x7C, 0x0,  // Char 'o'
0x0, 0xFE, 0xFE, 0x12, 0x12, 0x1E, 0xC, 0x0,  // Char 'p'
0x0, 0x3C, 0x7E, 0x42, 0xC2, 0xFE, 0xBC, 0x0,  // Char 'q'
0x0, 0xFE, 0xFE, 0x32, 0x72, 0xDE, 0x8C, 0x0,  // Char 'r'
0x0, 0x4C, 0xDE, 0x92, 0x92, 0xF6, 0x64, 0x0,  // Char 's'
0x0, 0x2, 0x2, 0xFE, 0xFE, 0x2, 0x2, 0x0,  // Char 't'
0x0, 0x7E, 0xFE, 0x80, 0x80, 0xFE, 0x7E, 0x0,  // Char 'u'
0x0, 0x3E, 0x7E, 0xC0, 0xC0, 0x7E, 0x3E, 0x0,  // Char 'v'
0x0, 0xFE, 0xFE, 0x60, 0x30, 0x30, 0x60, 0xFE,  // Char 'w'
0x0, 0xC6, 0xEE, 0x38, 0x38, 0xEE, 0xC6, 0x0,  // Char 'x'
0x0, 0xE, 0x1E, 0xF0, 0xF0, 0x1E, 0xE, 0x0,  // Char 'y'
0x0, 0xC2, 0xE2, 0xB2, 0x9A, 0x8E, 0x86, 0x0,  // Char 'z'
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, 0, 0, // NULL
  /*
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0xC3, 0x23, 0x10, 0x8, 0xC4, 0xC3,  // Char '%'
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0x0, 0x80, 0x60, 0x60, 0x0, 0x0,  // Char ','
0x10, 0x10, 0x10, 0x10, 0x10, 0x0,  // Char '-'
0x0, 0x0, 0x60, 0x60, 0x0, 0x0,  // Char '.'
0x80, 0x40, 0x20, 0x10, 0x8, 0x4,  // Char '/'
0x7C, 0xA2, 0x92, 0x8A, 0x7C, 0x0,  // Char '0'
0x0, 0x84, 0xFE, 0x80, 0x0, 0x0,  // Char '1'
0x84, 0xC2, 0xA2, 0x92, 0x8C, 0x0,  // Char '2'
0x44, 0x82, 0x92, 0x92, 0x6C, 0x0,  // Char '3'
0x0, 0x1E, 0x10, 0x10, 0xFC, 0x0,  // Char '4'
0x9E, 0x92, 0x92, 0x92, 0x62, 0x0,  // Char '5'
0x7C, 0x92, 0x92, 0x92, 0x60, 0x0,  // Char '6'
0x2, 0xC2, 0x22, 0x1A, 0x6, 0x0,  // Char '7'
0x6C, 0x92, 0x92, 0x92, 0x6C, 0x0,  // Char '8'
0xC, 0x92, 0x92, 0x92, 0x7C, 0x0,  // Char '9'
0x0, 0xCC, 0xCC, 0x0, 0x0, 0x0,  // Char ':'
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0x28, 0x28, 0x28, 0x28, 0x28, 0x0,  // Char '='
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0xF8, 0x24, 0x22, 0x24, 0xF8, 0x0,  // Char 'A'
0xFE, 0x92, 0x92, 0x92, 0x6C, 0x0,  // Char 'B'
0x7C, 0x82, 0x82, 0x82, 0x44, 0x0,  // Char 'C'
0xFE, 0x82, 0x82, 0x44, 0x38, 0x0,  // Char 'D'
0xFE, 0x92, 0x92, 0x82, 0x82, 0x0,  // Char 'E'
0xFE, 0x12, 0x12, 0x2, 0x2, 0x0,  // Char 'F'
0x7C, 0x82, 0x92, 0x92, 0x74, 0x0,  // Char 'G'
0xFE, 0x10, 0x10, 0x10, 0xFE, 0x0,  // Char 'H'
0x0, 0x82, 0xFE, 0x82, 0x0, 0x0,  // Char 'I'
0x60, 0x80, 0x82, 0x7E, 0x2, 0x0,  // Char 'J'
0xFE, 0x10, 0x18, 0x24, 0x42, 0x80,  // Char 'K'
0xFE, 0x80, 0x80, 0x80, 0x80, 0x80,  // Char 'L'
0xFE, 0x4, 0x8, 0x8, 0x4, 0xFE,  // Char 'M'
0xFE, 0x4, 0x8, 0x10, 0x20, 0xFE,  // Char 'N'
0x7C, 0x82, 0x82, 0x82, 0x7C, 0x0,  // Char 'O'
0xFE, 0x12, 0x12, 0x12, 0xC, 0x0,  // Char 'P'
0xFC, 0x42, 0xA2, 0x82, 0x7C, 0x0,  // Char 'Q'
0xFE, 0x12, 0x12, 0x32, 0x4C, 0x80,  // Char 'R'
0x4C, 0x92, 0x92, 0x92, 0x64, 0x0,  // Char 'S'
0x2, 0x2, 0xFE, 0x2, 0x2, 0x0,  // Char 'T'
0x7E, 0x80, 0x80, 0x80, 0x7E, 0x0,  // Char 'U'
0xE, 0x30, 0xC0, 0x30, 0xE, 0x0,  // Char 'V'
0x7E, 0x80, 0x60, 0x80, 0x7E, 0x0,  // Char 'W'
0xC6, 0x28, 0x10, 0x28, 0xC6, 0x0,  // Char 'X'
0x6, 0x8, 0xF0, 0x8, 0x6, 0x0,  // Char 'Y'
0xC2, 0xA2, 0x92, 0x8A, 0x86, 0x0,  // Char 'Z'
0, 0, 0, 0, 0, 0, // NULL
0x4, 0x8, 0x10, 0x20, 0x40, 0x80,  // Char '\'
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0x80, 0x80, 0x80, 0x80, 0x80, 0x80,  // Char '_'
0, 0, 0, 0, 0, 0, // NULL
0xF8, 0x24, 0x22, 0x24, 0xF8, 0x0,  // Char 'a'
0xFE, 0x92, 0x92, 0x92, 0x6C, 0x0,  // Char 'b'
0x7C, 0x82, 0x82, 0x82, 0x44, 0x0,  // Char 'c'
0xFE, 0x82, 0x82, 0x44, 0x38, 0x0,  // Char 'd'
0xFE, 0x92, 0x92, 0x82, 0x82, 0x0,  // Char 'e'
0xFE, 0x12, 0x12, 0x2, 0x2, 0x0,  // Char 'f'
0x7C, 0x82, 0x92, 0x92, 0x74, 0x0,  // Char 'g'
0xFE, 0x10, 0x10, 0x10, 0xFE, 0x0,  // Char 'h'
0x0, 0x82, 0xFE, 0x82, 0x0, 0x0,  // Char 'i'
0x60, 0x80, 0x82, 0x7E, 0x2, 0x0,  // Char 'j'
0xFE, 0x10, 0x18, 0x24, 0x42, 0x80,  // Char 'k'
0xFE, 0x80, 0x80, 0x80, 0x80, 0x80,  // Char 'l'
0xFE, 0x4, 0x8, 0x8, 0x4, 0xFE,  // Char 'm'
0xFE, 0x4, 0x8, 0x10, 0x20, 0xFE,  // Char 'n'
0x7C, 0x82, 0x82, 0x82, 0x7C, 0x0,  // Char 'o'
0xFE, 0x12, 0x12, 0x12, 0xC, 0x0,  // Char 'p'
0xFC, 0x42, 0xA2, 0x82, 0x7C, 0x0,  // Char 'q'
0xFE, 0x12, 0x12, 0x32, 0x4C, 0x80,  // Char 'r'
0x4C, 0x92, 0x92, 0x92, 0x64, 0x0,  // Char 's'
0x2, 0x2, 0xFE, 0x2, 0x2, 0x0,  // Char 't'
0x7E, 0x80, 0x80, 0x80, 0x7E, 0x0,  // Char 'u'
0xE, 0x30, 0xC0, 0x30, 0xE, 0x0,  // Char 'v'
0x7E, 0x80, 0x60, 0x80, 0x7E, 0x0,  // Char 'w'
0xC6, 0x28, 0x10, 0x28, 0xC6, 0x0,  // Char 'x'
0x6, 0x8, 0xF0, 0x8, 0x6, 0x0,  // Char 'y'
0xC2, 0xA2, 0x92, 0x8A, 0x86, 0x0,  // Char 'z'
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
0, 0, 0, 0, 0, 0, // NULL
  */
};

void obdRefresh()
{
  int i = 0;

  if(!basei2cIsOnline(&target)) {
    initialized = false;
    return;
  }
  
  if(!initialized) {
    SSD1306_command(SSD1306_DISPLAYOFF);          // 0xAE
    SSD1306_command(SSD1306_SETDISPLAYCLOCKDIV);  // 0xD5
    SSD1306_command(0x80);                        // the suggested ratio 0x80
    SSD1306_command(SSD1306_SETMULTIPLEX);        // 0xA8
    SSD1306_command(SSD1306_LCDHEIGHT - 1);
    SSD1306_command(SSD1306_SETDISPLAYOFFSET);    // 0xD3
    SSD1306_command(0x0);                         // no offset
    SSD1306_command(SSD1306_SETSTARTLINE | 0x0);  // line #0
    SSD1306_command(SSD1306_CHARGEPUMP);          // 0x8D
    SSD1306_command(0x14);
    SSD1306_command(SSD1306_MEMORYMODE);          // 0x20
    SSD1306_command(0x00);                        // 0x0 act like ks0108
    SSD1306_command(SSD1306_SEGREMAP | 0x1);
    SSD1306_command(SSD1306_COMSCANDEC);
    SSD1306_command(SSD1306_SETCOMPINS);          // 0xDA
    SSD1306_command(0x12);
    SSD1306_command(SSD1306_SETCONTRAST);         // 0x81
    SSD1306_command(0xCF);
    SSD1306_command(SSD1306_SETPRECHARGE);        // 0xd9
    SSD1306_command(0xF1);
    SSD1306_command(SSD1306_SETVCOMDETECT);       // 0xDB
    SSD1306_command(0x40);
    SSD1306_command(SSD1306_DISPLAYALLON_RESUME); // 0xA4
    SSD1306_command(SSD1306_NORMALDISPLAY);       // 0xA6
    SSD1306_command(SSD1306_DEACTIVATE_SCROLL);
    
    SSD1306_command(SSD1306_DISPLAYON);
    
    for(i = 0; i < DISP_ROWS; i++) {
      modifiedLeft[i] = 0;
      modifiedRight[i] = DISP_COLS-1;
    }

    scanRow = 0;
    initialized = true;
    scanning = false;
  }

  while(scanRow < DISP_ROWS) {    
    if(!scanning && modifiedLeft[scanRow] > -1) {
      // Initialize the scan of a (partial) row

      scanning = true;
      scanCol = modifiedLeft[scanRow];
      
      SSD1306_command(SSD1306_PAGEADDR);
      SSD1306_command(scanRow);
      SSD1306_command(scanRow);
      
      SSD1306_command(SSD1306_COLUMNADDR);
      SSD1306_command(scanCol*FONT_WIDTH);
      SSD1306_command((uint8_t) ~0U);
    }

    while(scanning && scanCol < modifiedRight[scanRow]+1) {
      // We're scanning a row and not done yet
      
      uint8_t buffer[FONT_WIDTH], chr = displayBuffer[scanRow*DISP_COLS+scanCol];

      CS_MEMCPY(buffer, &fontData[(chr & 0x7F)*FONT_WIDTH], sizeof(buffer));

      if(chr & 0x80) {
	for(i = 0; i < sizeof(buffer); i++)
	  buffer[i] = ~buffer[i];
      }

      const int size = MIN(sizeof(buffer), DISP_WIDTH - scanCol*FONT_WIDTH);
      SSD1306_data(buffer, size);
      scanCol++;

      if(vpMode.silent)
	// Supposed to be silent, only one column at a time to save bandwidth
	return;
    }

    if(scanning && scanCol > modifiedRight[scanRow]) {
      // Done with the scan line
      modifiedLeft[scanRow++] = scanCol = -1;
      scanning = false;
      return; // We refresh no more than one row at a time
    }

    scanRow++;
  }

  scanRow = 0;
}


